# Spec: CI/CD & Release Flow

branch: feature/cicd-release-flow

## Status
Draft

## Problem
Trailproof's Core API is complete and merged but there's no way to publish the SDKs to PyPI or npm, no LICENSE file, no README, and no changelog. Developers can't `pip install trailproof` or `npm install @kyberonai/trailproof`. The project needs publishing infrastructure using tokenless OIDC trusted publishers before the first v0.1.0 release.

## Goals
- Add Apache 2.0 LICENSE file
- Add README.md with install instructions, quickstart examples for both SDKs, and badges
- Add auto-generated CHANGELOG.md from conventional commits using git-cliff
- Create GitHub Actions publish workflows for PyPI (OIDC) and npm (OIDC) triggered on v* tags
- Update license declarations in pyproject.toml and package.json from MIT to Apache-2.0
- Document the version bump + release checklist

## Non-Goals
- Auto-versioning tools that bump versions automatically (semantic-release, release-please)
- Monorepo release orchestration
- Nightly, canary, or pre-release builds
- Mintlify documentation site (that's Phase 3)
- Changes to the CI test workflow (ci.yml already exists and works)
- Changes to any library source code

## Background
Both SDKs are at v0.1.0 (already set in pyproject.toml and package.json). The GitHub repo is `KyberonAi/trailproof`. A CI workflow (`.github/workflows/ci.yml`) already runs Python 3.11-3.13 and Node 18/20/22 tests on push/PR to main.

PyPI Trusted Publisher and npm Trusted Publisher are already configured by the user with environment name `release`. Both use OIDC — no API tokens or secrets needed.

pyproject.toml currently declares `license = "MIT"` and package.json declares `"license": "MIT"` — both need updating to Apache-2.0.

## Solution Overview
Add the publishing prerequisites (LICENSE, README, CHANGELOG, cliff.toml) and two GitHub Actions workflows that trigger on `v*` tags. Each workflow uses the `release` environment (manual approval gate) and publishes via OIDC with `id-token: write`. A version bump checklist documents what to update before tagging.

## Design Details

### Data Model
No library code changes. This spec adds project-level files only.

### API Surface

```python
# Python — no API changes
# This spec adds no library code
```

```typescript
// TypeScript — no API changes
// This spec adds no library code
```

### Files to Create

**LICENSE** — Apache License 2.0 full text, copyright Kyberon AI, year 2025.

**README.md** — structured as:
1. Title + one-line description + badges (PyPI, npm, license, CI status)
2. What it does (4-5 bullet points: hash chain, HMAC, dual SDK, stores, query)
3. Install — Python (pip, uv) and TypeScript (npm) side by side
4. Quickstart — emit, query, verify examples for both Python and TypeScript
5. Features table
6. API overview — 5 methods with one-line descriptions
7. Configuration examples — memory, JSONL, signing, default tenant
8. Links: SPEC.md, CHANGELOG, license

**CHANGELOG.md** — auto-generated by git-cliff from conventional commits. Covers all commits from project start through HEAD. Keep a Changelog format.

**cliff.toml** — git-cliff configuration:
- Conventional commit parsing (feat → Added, fix → Fixed, docs → Documentation, chore/refactor → Changed, test → Testing)
- Keep a Changelog output format
- GitHub compare URLs between tags
- Skip commits with "Merge" prefix

**publish-python.yml** — GitHub Actions workflow:
- Trigger: push tags matching `v*`
- Environment: `release` (manual approval)
- Permissions: `id-token: write`, `contents: read`
- Steps: checkout → setup Python 3.11 → install build → `python -m build` in python/ → publish via `pypa/gh-action-pypi-publish@release/v1` with `packages-dir: python/dist/`

**publish-npm.yml** — GitHub Actions workflow:
- Trigger: push tags matching `v*`
- Environment: `release` (manual approval)
- Permissions: `id-token: write`, `contents: read`
- Steps: checkout → setup Node 20 with registry-url `https://registry.npmjs.org` → `npm ci` in typescript/ → `npm run build` in typescript/ → `npm publish --provenance --access public` in typescript/

### Files to Modify

**python/pyproject.toml** — change `license = "MIT"` to `license = "Apache-2.0"`

**typescript/package.json** — change `"license": "MIT"` to `"license": "Apache-2.0"`

### Key Logic

**OIDC Trusted Publishing** — both workflows use GitHub's OIDC provider to authenticate with package registries. No secrets or API tokens stored in GitHub. The `release` environment requires manual approval before the workflow proceeds, acting as a release gate.

**git-cliff** — installed locally as a dev tool (not in CI). Run `git-cliff -o CHANGELOG.md` before tagging a release. Parses conventional commit messages and groups them by type.

**Version Bump Checklist** (documented in README or RELEASING.md):
1. Update version in `python/pyproject.toml`
2. Update version in `typescript/package.json`
3. Regenerate changelog: `git-cliff -o CHANGELOG.md`
4. Commit: `chore: bump version to vX.Y.Z`
5. Tag: `git tag vX.Y.Z`
6. Push: `git push origin main --tags`
7. Approve in GitHub environment UI

## Edge Cases
- First release (v0.1.0): CHANGELOG covers all commits from project start, no previous tag to compare against
- Tag pushed without version bump: workflow publishes whatever version is in pyproject.toml/package.json — the checklist prevents this but there's no automated guard
- OIDC token failure: workflow fails with clear error from GitHub/PyPI/npm — no fallback to token-based auth
- npm provenance requires npm CLI 9.5.0+ — Node 20 LTS ships with a compatible version via setup-node
- git-cliff not installed locally: changelog step fails with a clear "command not found" — it's a local dev tool, not a CI dependency

## Open Questions
None — all decisions made.

## Out of Scope
- CI test workflow changes (ci.yml already works)
- Auto-version bumping (semantic-release, release-please)
- GitHub Release creation with assets (can be added later)
- Nightly/canary/pre-release channels
- Docker image publishing

## Acceptance Criteria
- [ ] LICENSE file contains full Apache License 2.0 text with "Copyright 2026 Kyberon AI"
- [ ] pyproject.toml license field updated to "Apache-2.0"
- [ ] package.json license field updated to "Apache-2.0"
- [ ] README.md has badges for PyPI version, npm version, license, and CI status
- [ ] README.md has install instructions for both Python (pip/uv) and TypeScript (npm)
- [ ] README.md has quickstart examples showing emit, query, verify for both SDKs
- [ ] README.md has API overview table and configuration examples
- [ ] README.md documents the version bump / release checklist
- [ ] cliff.toml configures git-cliff for conventional commit parsing with Keep a Changelog format
- [ ] CHANGELOG.md is generated from git history covering all existing commits
- [ ] publish-python.yml triggers on v* tags and uses `release` environment
- [ ] publish-python.yml uses `pypa/gh-action-pypi-publish@release/v1` with OIDC (id-token: write)
- [ ] publish-python.yml builds from python/ directory
- [ ] publish-npm.yml triggers on v* tags and uses `release` environment
- [ ] publish-npm.yml publishes with `--provenance --access public` and OIDC (id-token: write)
- [ ] publish-npm.yml builds and publishes from typescript/ directory
- [ ] Neither publish workflow contains hardcoded secrets or tokens

## Testing Guidelines
No library code changes — no unit tests needed. Validation approach:
- LICENSE file exists and contains "Apache License, Version 2.0"
- README.md renders correctly in GitHub preview
- CHANGELOG.md generates without errors via `git-cliff -o CHANGELOG.md`
- Publish workflows pass GitHub Actions syntax validation (actionlint if available)
- Dry-run: push a test tag to verify OIDC handshake (manual, post-merge)
