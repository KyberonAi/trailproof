# Plan: CI/CD & Release Flow

## Context

Trailproof's Core API (Phase 1) is complete and merged. Both SDKs are at v0.1.0 but there's no way to publish them — no LICENSE, no README (just a 2-line stub), no CHANGELOG, and no publish workflows. PyPI and npm OIDC Trusted Publishers are already configured by the user with environment name `release`. This plan adds all publishing prerequisites and workflows so the first `v0.1.0` tag triggers a tokenless publish to both registries.

Spec: `.claude/specs/cicd-release-flow.md` (approved)

## Tasks

### Task 1 — Add Apache 2.0 LICENSE

- [x] **Create** `LICENSE` with full Apache 2.0 text, "Copyright 2026 Kyberon AI"
- **Commit:** `chore: add Apache 2.0 LICENSE`
- **Verify:** `grep "Apache License" LICENSE && grep "Copyright 2026 Kyberon AI" LICENSE`

### Task 2 — Update license declarations

- [x] **Edit** `python/pyproject.toml`: `license = "MIT"` → `license = "Apache-2.0"`
- [x] **Edit** `typescript/package.json`: `"license": "MIT"` → `"license": "Apache-2.0"`
- **Commit:** `chore: update license declarations to Apache-2.0`
- **Verify:** `cd python && make all && cd ../typescript && npm run all`

### Task 3 — Add cliff.toml

- [x] **Create** `cliff.toml` — git-cliff config with:
  - Conventional commit parsing (feat→Added, fix→Fixed, docs→Documentation, chore/ci→Maintenance, refactor→Changed, test→Testing)
  - Keep a Changelog output format
  - GitHub compare URLs between tags
  - Skip merge commits (`{ message = "^Merge", skip = true }`)
  - Tag pattern: `v[0-9]*`
- **Commit:** `chore: add cliff.toml for git-cliff changelog generation`
- **Verify:** `python3 -c "import tomllib; tomllib.load(open('cliff.toml','rb'))"`

### Task 4 — Generate CHANGELOG.md

- [x] **Run** `git-cliff -o CHANGELOG.md` (generates from full git history, single `[Unreleased]` section since no tags exist yet)
- **Commit:** `chore: generate CHANGELOG.md from git history`
- **Verify:** `head -20 CHANGELOG.md` shows header + `## [Unreleased]` + grouped commits

### Task 5 — Replace README.md

- [x] **Rewrite** `README.md` (replace 2-line stub) with:
  1. Title + tagline + 4 badges (PyPI, npm, license, CI)
  2. What It Does (5 bullet points)
  3. Install (Python pip/uv + TypeScript npm)
  4. Quickstart (emit, query, verify for both SDKs)
  5. Features table
  6. API overview (5 methods, Python vs TypeScript columns)
  7. Configuration examples (both SDKs)
  8. Releasing checklist (version bump → tag → push → approve)
  9. Links (SPEC.md, CHANGELOG, LICENSE)
- Badge URLs: `img.shields.io/pypi/v/trailproof.svg`, `img.shields.io/npm/v/@kyberonai/trailproof.svg`, license badge, CI badge from `github.com/KyberonAi/trailproof/actions/workflows/ci.yml/badge.svg`
- Note: `pyproject.toml` has `readme = "../README.md"` so PyPI pulls from this file
- **Commit:** `docs: add README with badges, quickstart, and release checklist`
- **Verify:** visual check in GitHub preview; all badge URLs well-formed

### Task 6 — Add PyPI publish workflow

- [x] **Create** `.github/workflows/publish-python.yml`:
  - Trigger: `push: tags: ["v*"]`
  - `environment: release` (manual approval gate)
  - `permissions: id-token: write, contents: read`
  - Steps: checkout → setup-python 3.11 → `pip install build` → `python -m build` (in python/) → `pypa/gh-action-pypi-publish@release/v1` with `packages-dir: python/dist/`
  - Zero secrets — fully OIDC
- Action versions: `actions/checkout@v4`, `actions/setup-python@v5` (match ci.yml)
- **Commit:** `chore: add PyPI publish workflow using OIDC trusted publisher`
- **Verify:** YAML syntax valid; no hardcoded tokens

### Task 7 — Add npm publish workflow

- [x] **Create** `.github/workflows/publish-npm.yml`:
  - Trigger: `push: tags: ["v*"]`
  - `environment: release` (manual approval gate)
  - `permissions: id-token: write, contents: read`
  - Steps: checkout → setup-node 20 with `registry-url: https://registry.npmjs.org` → `npm ci` (in typescript/) → `npm run build` (in typescript/) → `npm publish --provenance --access public` (in typescript/)
  - Zero secrets — fully OIDC via npm Trusted Publisher
- Action versions: `actions/checkout@v4`, `actions/setup-node@v4` (match ci.yml)
- **Commit:** `chore: add npm publish workflow using OIDC trusted publisher`
- **Verify:** YAML syntax valid; no hardcoded tokens; `--access public` present (required for scoped package)

## Critical Files

| File | Action | Notes |
|------|--------|-------|
| `LICENSE` | create | Apache 2.0 full text |
| `python/pyproject.toml` | edit line 10 | `"MIT"` → `"Apache-2.0"` |
| `typescript/package.json` | edit line 46 | `"MIT"` → `"Apache-2.0"` |
| `cliff.toml` | create | git-cliff config |
| `CHANGELOG.md` | create | generated by git-cliff |
| `README.md` | rewrite | replace 2-line stub |
| `.github/workflows/publish-python.yml` | create | PyPI OIDC |
| `.github/workflows/publish-npm.yml` | create | npm OIDC |
| `.github/workflows/ci.yml` | reference only | pattern for action versions |

## Verification

After all 7 tasks:

1. `make all` in python/ — tests still pass
2. `npm run all` in typescript/ — tests still pass
3. `ls LICENSE CHANGELOG.md README.md cliff.toml` — all exist
4. `grep "Apache-2.0" python/pyproject.toml typescript/package.json` — both match
5. `ls .github/workflows/publish-*.yml` — both exist
6. `grep -r "secrets\." .github/workflows/publish-*.yml` — no matches (tokenless)
7. `git log --oneline` — 7 new commits, all conventional format
